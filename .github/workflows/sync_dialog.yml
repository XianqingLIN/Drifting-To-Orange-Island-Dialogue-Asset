name: Sync Feishu Table to GitHub

on:
  # 每天凌晨 3 点自动跑一次（可选）
  schedule:
    - cron: '0 3 * * *'

  # 手动触发
  workflow_dispatch:

  # 飞书 Webhook 触发（repository_dispatch）
  repository_dispatch:
    types: [feishu_update]

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉仓库源码（含脚本）
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 装 Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. 装依赖
      - name: Install deps
        run: |
          pip install requests flatbuffers

      # 4. 拉飞书表 → 生成 .bytes
      - name: Pull & convert
        env:
          FEISHU_APP_ID:     ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_APP_TOKEN:  ${{ secrets.FEISHU_APP_TOKEN }}
        run: |
          python tools/pull_feishu.py

      # 5. 把最新 .bytes 提交回仓库
      - name: Commit & push
        uses: EndBug/add-and-commit@v9
        with:
          add: 'feishu_tables/**/*.bytes'
          message: 'chore: auto-sync Feishu → .bytes'
          author_name: 'github-actions[bot]'
          author_email: 'github-actions[bot]@users.noreply.github.com'
